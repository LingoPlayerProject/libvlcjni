From ced8bab2912f3393e1e25fa5fe4263259b15b19a Mon Sep 17 00:00:00 2001
Message-Id: <ced8bab2912f3393e1e25fa5fe4263259b15b19a.1659372189.git.thomas@gllm.fr>
In-Reply-To: <5b01e96eabd14521cfeb33b5ac11495b77f894cc.1659372189.git.thomas@gllm.fr>
References: <5b01e96eabd14521cfeb33b5ac11495b77f894cc.1659372189.git.thomas@gllm.fr>
From: Thomas Guillem <thomas@gllm.fr>
Date: Wed, 27 Jul 2022 11:19:17 +0200
Subject: [PATCH 15/19] contrib: ffmpeg: fix relocation out of range error on
 AArch64

ld: error: /home/tom/work/git/vlc-android/vlc/contrib/aarch64-linux-android/lib/libavcodec.a(videodsp.o):(function ff_prefetch_aarch64: .text+0x10): relocation R_AARCH64_CONDBR19 out of range: 13363404 is not in [-1048576, 1048575]; references ff_prefetch_aarch64
>>> referenced by videodsp.S:26 (libavcodec/aarch64/videodsp.S:26)
>>> defined in /home/tom/work/git/vlc-android/vlc/contrib/aarch64-linux-android/lib/libavcodec.a(videodsp.o)
clang++: error: linker command failed with exit code 1 (use -v to see invocation)

Backport an existing patch from the master branch.
---
 ...64-fix-relocation-out-of-range-error.patch | 35 +++++++++++++++++++
 contrib/src/ffmpeg/rules.mak                  |  1 +
 2 files changed, 36 insertions(+)
 create mode 100644 contrib/src/ffmpeg/0001-lavc-aarch64-fix-relocation-out-of-range-error.patch

diff --git a/contrib/src/ffmpeg/0001-lavc-aarch64-fix-relocation-out-of-range-error.patch b/contrib/src/ffmpeg/0001-lavc-aarch64-fix-relocation-out-of-range-error.patch
new file mode 100644
index 0000000000..43f9cc15ee
--- /dev/null
+++ b/contrib/src/ffmpeg/0001-lavc-aarch64-fix-relocation-out-of-range-error.patch
@@ -0,0 +1,35 @@
+From 378ad2f8fd7c5b5d9d1b3170282ce6b8a289ba07 Mon Sep 17 00:00:00 2001
+From: Zhao Zhili <zhilizhao@tencent.com>
+Date: Mon, 13 Sep 2021 15:24:09 +0800
+Subject: [PATCH] lavc/aarch64: fix relocation out of range error
+MIME-Version: 1.0
+Content-Type: text/plain; charset=UTF-8
+Content-Transfer-Encoding: 8bit
+
+Use a temporary label instead of global function symbol for b.gt.
+
+Signed-off-by: Martin Storsj√∂ <martin@martin.st>
+---
+ libavcodec/aarch64/videodsp.S | 3 ++-
+ 1 file changed, 2 insertions(+), 1 deletion(-)
+
+diff --git a/libavcodec/aarch64/videodsp.S b/libavcodec/aarch64/videodsp.S
+index 24067cc2af..fe2da0658e 100644
+--- a/libavcodec/aarch64/videodsp.S
++++ b/libavcodec/aarch64/videodsp.S
+@@ -19,10 +19,11 @@
+ #include "libavutil/aarch64/asm.S"
+ 
+ function ff_prefetch_aarch64, export=1
++1:
+         subs            w2,  w2,  #2
+         prfm            pldl1strm, [x0]
+         prfm            pldl1strm, [x0,  x1]
+         add             x0,  x0,  x1,  lsl #1
+-        b.gt            X(ff_prefetch_aarch64)
++        b.gt            1b
+         ret
+ endfunc
+-- 
+2.35.1
+
diff --git a/contrib/src/ffmpeg/rules.mak b/contrib/src/ffmpeg/rules.mak
index 1dcb2b4b9c..4c0ef53ade 100644
--- a/contrib/src/ffmpeg/rules.mak
+++ b/contrib/src/ffmpeg/rules.mak
@@ -228,6 +228,7 @@ ffmpeg: ffmpeg-$(FFMPEG_BASENAME).tar.xz .sum-ffmpeg
 	$(APPLY) $(SRC)/ffmpeg/0001-avcodec-vp9-Do-not-destroy-uninitialized-mutexes-con.patch
 	$(APPLY) $(SRC)/ffmpeg/0001-ffmpeg-add-target_os-support-for-emscripten.patch
 	$(APPLY) $(SRC)/ffmpeg/0001-dxva2_hevc-don-t-use-frames-as-reference-if-they-are.patch
+	$(APPLY) $(SRC)/ffmpeg/0001-lavc-aarch64-fix-relocation-out-of-range-error.patch
 	$(MOVE)
 
 .ffmpeg: ffmpeg
-- 
2.35.1

